{% load block_tags %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ website.title }} - Web Lego</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .editor-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* –ü–∞–Ω–µ–ª—å –±–ª–æ–∫–æ–≤ —Å–ª–µ–≤–∞ */
        .blocks-panel {
            width: 280px;
            background: white;
            border-right: 2px solid #e5e7eb;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .blocks-panel h3 {
            color: #7c3aed;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .block-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .block-type-btn {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e5e7eb;
            padding: 1rem;
            border-radius: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .block-type-btn:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .block-type-btn:active {
            cursor: grabbing;
        }

        /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - —Ä–µ–¥–∞–∫—Ç–æ—Ä */
        .editor-area {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
            padding: 2rem;
            position: relative;
        }

        .editor-canvas {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 2rem;
        }

        .block-item {
            position: relative;
            margin-bottom: 1rem;
            border: 2px dashed transparent;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            cursor: move;
        }

        .block-item:hover {
            border-color: #8b5cf6;
            background: #faf5ff;
        }

        .block-item.dragging {
            opacity: 0.5;
        }

        .block-item.drag-over {
            border-color: #10b981;
            background: #d1fae5;
        }

        .block-item.selected {
            border-color: #8b5cf6;
            background: #faf5ff;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .block-content {
            pointer-events: none;
        }

        .block-content .editable {
            pointer-events: auto;
        }

        .block-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            display: none;
            gap: 0.5rem;
        }

        .block-item.selected .block-controls {
            display: flex;
        }

        .block-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .block-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .block-btn.delete {
            background: #ef4444;
        }

        /* –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–ø—Ä–∞–≤–∞ */
        .settings-panel {
            width: 320px;
            background: white;
            border-left: 2px solid #e5e7eb;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .settings-panel h3 {
            color: #7c3aed;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .color-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-input input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state p {
            margin-bottom: 1rem;
        }

        /* Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ */
        .editable {
            outline: none;
            min-height: 1.5em;
        }

        .editable:focus {
            background: #fef3c7;
            border-radius: 4px;
        }

        /* Drop zone */
        .drop-zone {
            min-height: 100px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #8b5cf6;
            background: #faf5ff;
            color: #7c3aed;
        }

        /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä */
        .preview-mode {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 999;
        }

        .preview-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow: auto;
        }

        .preview-modal.active {
            display: block;
        }

        .preview-content {
            background: white;
            max-width: 1200px;
            margin: 2rem auto;
            border-radius: 10px;
            padding: 2rem;
            position: relative;
        }

        .preview-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #ef4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
        }

        @media (max-width: 1200px) {
            .blocks-panel,
            .settings-panel {
                width: 250px;
            }
        }

        @media (max-width: 968px) {
            .editor-container {
                flex-direction: column;
            }
            
            .blocks-panel,
            .settings-panel {
                width: 100%;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <a href="{% url 'dashboard' %}" class="logo">Web Lego</a>
            <div class="nav-links">
                <button class="nav-link" onclick="openPreview()">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                <a href="{% url 'view_website' website.id %}" target="_blank" class="nav-link">üåê –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç</a>
                <a href="{% url 'dashboard' %}" class="nav-link">‚Üê –ù–∞–∑–∞–¥</a>
            </div>
        </nav>
    </header>

    <!-- Editor Container -->
    <div class="editor-container">
        <!-- –ü–∞–Ω–µ–ª—å –±–ª–æ–∫–æ–≤ -->
        <div class="blocks-panel">
            <h3>üì¶ –ë–ª–æ–∫–∏</h3>
            <div class="block-types">
                <div class="block-type-btn" draggable="true" data-type="heading">
                    üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫
                </div>
                <div class="block-type-btn" draggable="true" data-type="text">
                    üìÑ –¢–µ–∫—Å—Ç
                </div>
                <div class="block-type-btn" draggable="true" data-type="image">
                    üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </div>
                <div class="block-type-btn" draggable="true" data-type="video">
                    üé• –í–∏–¥–µ–æ
                </div>
                <div class="block-type-btn" draggable="true" data-type="button">
                    üîò –ö–Ω–æ–ø–∫–∞
                </div>
                <div class="block-type-btn" draggable="true" data-type="slider">
                    üé† –°–ª–∞–π–¥–µ—Ä
                </div>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="editor-area">
            <div class="editor-canvas" id="editor-canvas">
                {% if blocks %}
                    {% for block in blocks %}
                        <div class="block-item" data-block-id="{{ block.id }}" data-block-type="{{ block.block_type }}" draggable="true">
                            <div class="block-controls">
                                <button class="block-btn" onclick="editBlock({{ block.id }})">‚úèÔ∏è</button>
                                <button class="block-btn delete" onclick="deleteBlock({{ block.id }})">üóëÔ∏è</button>
                            </div>
                            <div class="block-content">
                                {{ block|render_block }}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–ª–æ–∫–∏ —Å—é–¥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–µ–Ω–¥–∏–Ω–≥</p>
                    </div>
                {% endif %}
                <div class="drop-zone" id="drop-zone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –±–ª–æ–∫ —Å—é–¥–∞</div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="settings-panel">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <form id="settings-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞</label>
                    <input type="text" name="title" class="form-input" value="{{ website.title }}">
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                    <div class="color-input">
                        <input type="color" name="background_color" value="{{ website.background_color|default:'#ffffff' }}">
                        <input type="text" class="form-input" value="{{ website.background_color|default:'#ffffff' }}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
                    <div class="color-input">
                        <input type="color" name="text_color" value="{{ website.text_color|default:'#000000' }}">
                        <input type="text" class="form-input" value="{{ website.text_color|default:'#000000' }}" readonly>
                    </div>
                </div>

                <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #7c3aed;">Header</h4>
                
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                    <input type="text" name="header_company_name" class="form-input" value="{{ website.header_company_name }}">
                </div>

                <div class="form-group">
                    <label class="form-label">–õ–æ–≥–æ—Ç–∏–ø</label>
                    <input type="file" name="header_logo" class="form-input" accept="image/*">
                    {% if website.header_logo %}
                        <img src="{{ website.header_logo.url }}" alt="Logo" style="max-width: 100px; margin-top: 0.5rem;">
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ Header</label>
                    <div class="color-input">
                        <input type="color" name="header_background_color" value="{{ website.header_background_color|default:'#ffffff' }}">
                        <input type="text" class="form-input" value="{{ website.header_background_color|default:'#ffffff' }}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ Header</label>
                    <div class="color-input">
                        <input type="color" name="header_text_color" value="{{ website.header_text_color|default:'#000000' }}">
                        <input type="text" class="form-input" value="{{ website.header_text_color|default:'#000000' }}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="header_show" {% if website.header_show %}checked{% endif %}>
                        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å Header
                    </label>
                </div>

                <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: #7c3aed;">Footer</h4>

                <div class="form-group">
                    <label class="form-label">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ Footer</label>
                    <textarea name="footer_content" class="form-input" rows="3">{{ website.footer_content }}</textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ Footer</label>
                    <div class="color-input">
                        <input type="color" name="footer_background_color" value="{{ website.footer_background_color|default:'#f3f4f6' }}">
                        <input type="text" class="form-input" value="{{ website.footer_background_color|default:'#f3f4f6' }}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ Footer</label>
                    <div class="color-input">
                        <input type="color" name="footer_text_color" value="{{ website.footer_text_color|default:'#000000' }}">
                        <input type="text" class="form-input" value="{{ website.footer_text_color|default:'#000000' }}" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="footer_show" {% if website.footer_show %}checked{% endif %}>
                        –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å Footer
                    </label>
                </div>

                <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-content">
            <button class="preview-close" onclick="closePreview()">√ó</button>
            <iframe src="{% url 'view_website' website.id %}" style="width: 100%; height: 80vh; border: none;"></iframe>
        </div>
    </div>

    <script>
        const websiteId = {{ website.id }};
        let selectedBlock = null;
        let draggedBlock = null;
        let draggedElement = null;
        let dragOverElement = null;

        // Drag & Drop –¥–ª—è –Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤ –∏–∑ –ø–∞–Ω–µ–ª–∏
        document.querySelectorAll('.block-type-btn').forEach(btn => {
            btn.addEventListener('dragstart', (e) => {
                draggedBlock = e.target.dataset.type;
                e.dataTransfer.effectAllowed = 'copy';
            });
        });

        const editorCanvas = document.getElementById('editor-canvas');
        const dropZone = document.getElementById('drop-zone');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤
        document.querySelectorAll('.block-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedElement = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', item.outerHTML);
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                document.querySelectorAll('.block-item').forEach(b => b.classList.remove('drag-over'));
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (item !== draggedElement) {
                    item.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('drag-over');
            });

            item.addEventListener('drop', async (e) => {
                e.preventDefault();
                item.classList.remove('drag-over');
                
                if (draggedElement && draggedElement !== item) {
                    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª–æ–∫–∞
                    const allBlocks = Array.from(document.querySelectorAll('.block-item'));
                    const draggedIndex = allBlocks.indexOf(draggedElement);
                    const targetIndex = allBlocks.indexOf(item);
                    
                    if (draggedIndex < targetIndex) {
                        item.parentNode.insertBefore(draggedElement, item.nextSibling);
                    } else {
                        item.parentNode.insertBefore(draggedElement, item);
                    }
                    
                    await reorderBlocks();
                }
            });
        });

        editorCanvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (draggedBlock) {
                e.dataTransfer.dropEffect = 'copy';
            } else {
                e.dataTransfer.dropEffect = 'move';
            }
        });

        editorCanvas.addEventListener('drop', async (e) => {
            e.preventDefault();
            if (draggedBlock) {
                await createBlock(draggedBlock);
                draggedBlock = null;
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞
        async function createBlock(blockType) {
            try {
                const response = await fetch(`/api/websites/${websiteId}/blocks/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        block_type: blockType,
                        data: {}
                    })
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–æ–∫–∞: ' + error.message);
            }
        }

        // –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤
        async function reorderBlocks() {
            const blocks = Array.from(document.querySelectorAll('.block-item'));
            const blockOrders = blocks.map((block, index) => ({
                id: parseInt(block.dataset.blockId),
                order: index
            }));

            try {
                const response = await fetch(`/api/websites/${websiteId}/blocks/reorder/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ blocks: blockOrders })
                });

                const result = await response.json();
                if (!result.success) {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è:', result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è:', error);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
        async function deleteBlock(blockId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) return;

            try {
                const response = await fetch(`/api/blocks/${blockId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const result = await response.json();
                if (result.success) {
                    const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
                    if (blockElement) {
                        blockElement.remove();
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞: ' + error.message);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞
        function editBlock(blockId) {
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            blockElement.classList.add('selected');
            selectedBlock = blockId;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const blockType = blockElement.dataset.blockType;
            openEditModal(blockId, blockType);
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
        function openEditModal(blockId, blockType) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            // –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π prompt –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
            if (blockType === 'text' || blockType === 'heading') {
                const newContent = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç:');
                if (newContent !== null) {
                    updateBlockData(blockId, { content: newContent });
                }
            } else {
                alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –±–ª–æ–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞
        async function updateBlockData(blockId, newData) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∞
                const response = await fetch(`/api/blocks/${blockId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        data: newData
                    })
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞: ' + error.message);
            }
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        function openPreview() {
            document.getElementById('preview-modal').classList.add('active');
        }

        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // –í—ã–±–æ—Ä –±–ª–æ–∫–∞
        document.querySelectorAll('.block-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.closest('.block-controls')) return;
                
                document.querySelectorAll('.block-item').forEach(b => b.classList.remove('selected'));
                item.classList.add('selected');
                selectedBlock = item.dataset.blockId;
            });
        });
    </script>
</body>
</html>
